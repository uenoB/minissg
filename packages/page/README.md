# @minissg/page

This library provides a feature to manage the set of webpages to be
generated by [Minissg].

## Install

Install the package by

```bash
npm install @minissg/page
```

and import it in the root file of your project as follows:

```js
import { Page } from "@minissg/page"
```

or

```js
import Page from "@minissg/page"
```

## Getting Started

Download a template project.

```bash
tiged uenob/minissg/template/page my_project
```

Change directory to the new directory and install all dependencies
by the `npm` command:

```bash
cd my_project
npm install
```

The following scripts are initially available:
* `npm run build` for static site generation for production.
* `npm run serve` for preview of the build result.
* `npm run dev` for starting Vite's dev server.

## Basic Usage

Each instance of the `Page` class represents a set of webpages.
The typical usage of the `Page` class is as follows:

1. Combined with `import.meta.glob` provided by Vite, create a `Page` object
   of a set of webpage component modules by `Page.create`.
   For example:

   ```js
   const page = Page.create({
     url: 'https://example.com/',
     pages: import.meta.glob('./pages/**/*.{md,mdx}'),
     substitutePath: s => s.slice('./pages/'.length)
   });
   ```

   The `url` parameter indicates the root URL of this website.
   `pages` has the map from file names to dynamic import functions
   provided by `import.meta.glob`.

   `substitutePath` removes `./pages/` prefix from each file name when
   making URL of each webpage.
   The URL of each webpage is obtained by transforming its file name
   after applying `substitutePath`.
   As a result, for example, a given module `pages/foo/bar.mdx` is
   associated with a webpage of URL `foo/bar/`.

2. Set `page.render` to a function indicating how to render a webpage
   component in a HTML file.
   The following example adds `DOCTYPE`, `html`, and `body` tags to
   `module.default` component and renders all of them by
   `virtual:minissg/self?renderer`.

   ```jsx
   import render from 'virtual:minissg/self?renderer'

   page.render = async function (module) {
     const Webpage = () => (
       <html>
         <body>
           <module.default page={this} />
         </body>
       </html>
     );
     return new Blob(['<!DOCTYPE html>\n', await render(Webpage)]);
   };
   ```

   In each MDX file, you can access to the `Page` object dedicated to
   that MDX file through `props.page` property.

3. Export the root page through the `main` function:

  ```js
  export main = () => page;
  ```

The above three fragments of code is placed in the same JSX file, say
`index.html.jsx`.
Set this file to the input of Vite in `vite.config.js` and do `vite build`.
Then you will find your website in `dist` directory.
An example of `vite.config.js` is given below:

```js
import { defineConfig } from 'vite'
import mdx from '@mdx-js/rollup'
import preact from '@preact/preset-vite'
import minissg from 'vite-plugin-minissg'
import minissgPreact from '@minissg/render-preact'

export default defineConfig({
  build: {
    rollupOptions: {
      input: './index.html.jsx'
    }
  },
  plugins: [
    minissg({
      render: {
        '**/*.jsx': minissgPreact()
      },
      plugins: () => [
        preact(),
        mdx({
          mdxExtensions: ['.mdx', '.mdx?MINISSG-COPY'],
          jsxImportSource: 'preact'
        })
      ]
    })
  ]
})
```

## References

This package provides the `Page` class having the following methods.

### Types

#### `Pairs`

`Pairs<Key, Value>` represents a sequence of key-value pairs.
It is either an `array`, `object`, promise of one of them,
or function returning `Pairs<Key, Value>`.
If `array` is given, each element must be either a pair
`[Key, Value]`, `object`, or function returning `Pairs<Key, Value>`.
If `object` is given as a `Pairs<Key, Value>`, each property must be
of type `Value`.

### `List`

`List<Value>` represents a sequence of values.
It is either an `Iterable<Value>`, `AsyncIterable<Value>`, or promise
of one of them, or function returning `List<Value>`.

### `RelPath`

`RelPath` is the type of objects of the form
`{ moduleName: string; stem: string; variant: string; fileName: string }`,
each of which represent relative paths between two `Page`s.

`Page` manages the following four kinds of paths:
* `moduleName` is the path of webpages.
  This is used to determine the URL of each webpage.
* `stem` identifies a content of a webpage regardless of its variants, such
as languages and formats.
* `variant` identifies a variants of the content.
* `fileName` is the path of source file.

### `Paginate`

```typescript
interface Paginate<Item, This> {
  pages: ReadonlyArray<Paginate<Item, This>>;
  page: This;
  pageIndex: number;
  itemIndex: number;
  items: readonly Item[];
  numAllItems: number;
}
```

### `AssetModule`

```typescript
interface AssetModule {
  default: string;
}
```

### `MainModule`

```typescript
interface MainModule {
  main: (context: Readonly<Context>) => Awaitable<Module>
}
```

### `Content` and `Module`

They are identical to [Minissg]'s `Content` and `Module` type.
See [Minissg's document] for details.

### `Delay`

`Delay` is a promise that can be used with React Suspense.
See [@minissg/async] for details.

### Class Methods

#### `Page.create(options, args...) => Page`

`Page.create` creates a new `Page` object with its contents.
The `options` argument specifies the contents and customizations.
The `args` arguments are passed to constructor of `Page` class, which does
not do anything by default and can be defined by creating a subclass.

The `options` object must have one of the following properties:

* `pages` of type `Pairs`.
  Its key must be either `string` or `RelPath`.
  Its value must be either a function returning `object`, `Page`, or
  `MainModule`.
* `load` of function returning `object`, `Page`, `MainModule`, or promise
  of one of them.

They are exclusive: `pages` is ignored if `load` is specified, and vice versa.

The `options` may have one of the following optional properties:

* `substitutePath` of function taking a `string` and returning either
  a `string` or `Promise<string>`.
* `assets` of type `Pairs`.
  Its key must be `string`.
  Its value must be either a `string` or function returning `AssetModule`
  or `Promise<AssetModule>`.
  This can be used only with `pages` property.
* `url` of type either `URL` or `string`.
* `parsePath` method taking a `string` and returning a `ParsePath` or
  `Promise<ParsePath>`.
* `render` method taking a `string` and returning a `Content` or
  `Promise<Content>`.

#### `Page.paginate(options, args...) => Page`

`Page.create` creates a new `Page` object with its contents by paginating
the given items.
Similarly to `Page.create`, `options` specifies the contents and `args`
are passed to constructor.

The `options` object must have the following properties:

* `items` of type `List`.
  Its value may be arbitrary type.
* `load` method that takes `Paginate` and returns either an `object`,
  `Page`, `MainModule`, or promise of one of them.

The following are options:

* `pageSize` of integer.
  Its default is 10.
* `paginatePath` method taking a `number` and returning a `RelPath` or
  `Promise<RelPath>`.
* `url`, `parsePath`, and `render` can be specified similarly to `Page.create`.

### Customization

The following methods can be overriden by either
specifying the corresponding options in `Page.create`,
overwriting `Page` object properties, or
creating a subclass of `Page`.

#### `Page.prototype.parsePath(fileName) => ParsePath`

#### `Page.prototype.paginatePath(index) => RelPath`

#### `Page.prototype.render(object) => Content`

#### `Page.Base`

### Instance Methods

#### `Page.prototype.moduleName => Delay<string>`

#### `Page.prototype.stem => Delay<string>`

#### `Page.prototype.variant => Delay<string>`

#### `Page.prototype.fileName => Delay<string>`

#### `Page.prototype.url => Delay<URL>`

#### `Page.prototype.parent => Delay<Page | undefined>`

#### `Page.prototype.root => Delay<Page>`

#### `Page.prototype.loadThis() => Delay<object | undefined>`

#### `Page.prototype.load() => Delay<object>`

#### `Page.prototype.children() => Delay<Array<[RelPath, Page]>>`

#### `Page.prototype.findByModuleName(path) => Delay<Page | undefined>`

#### `Page.prototype.findByFileName(path) => Delay<Page | undefined>`

#### `Page.prototype.find(path) => Delay<Page | undefined>`

#### `Page.prototype.findByStem(path) => Delay<Set<Page>>`

#### `Page.prototype.variants() => Delay<Set<Base>>`

## License

MIT

[Minissg]: https://github.com/uenoB/minissg
[Minissg's document]: https://github.com/uenoB/minissg/tree/main/packages/vite-plugin-minissg#readme
[@minissg/async]: https://github.com/uenoB/minissg/tree/main/packages/async#readme
